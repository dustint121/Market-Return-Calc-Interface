{% extends "base.html" %}

{% block content %}
<div class="box">
  <h2>SP500 Treemap Snapshots</h2>

  <div id="data-source-container"
     data-s3-enabled="{% if s3_enabled %}true{% else %}false{% endif %}"
     style="margin-bottom: 16px; display:flex; align-items:center; gap:12px;">

    <span style="font-size: 13px; color:#4b5563;">Data source:</span>
    <label class="switch">
      <input type="checkbox"
            id="data-source-toggle"
            {% if not s3_enabled %}disabled{% endif %}
            {% if s3_enabled and data_source == 's3' %}checked{% endif %}>
      <span class="slider round"></span>
    </label>
    <span id="data-source-label" style="font-size: 13px; color:#111827;">
      {% if s3_enabled and data_source == 's3' %}
        AWS S3
      {% else %}
        Local
      {% endif %}
    </span>
    {% if not s3_enabled %}
      <span style="font-size: 12px; color:#9ca3af;">S3 unavailable (missing or invalid AWS config)</span>
    {% endif %}
  </div>


  {% if files %}

    {# Group files into year -> month -> [filenames] #}
    {% set grouped = {} %}
    {% for name in files %}
      {% set base = name.replace('_treemap.html', '') %} {# YYYY-MM-DD #}
      {% set year = base[:4] %}
      {% set month = base[5:7] %}
      {% if year not in grouped %}
        {% set _ = grouped.update({year: {}}) %}
      {% endif %}
      {% if month not in grouped[year] %}
        {% set _ = grouped[year].update({month: []}) %}
      {% endif %}
      {% set _ = grouped[year][month].append(name) %}
    {% endfor %}

    <div>
      {# Loop years descending (most recent first) #}
      {% for year in grouped.keys()|list|sort(reverse=true) %}
        <details style="margin-bottom: 8px;" open>
          <summary style="cursor: pointer; font-weight: 600;">
            {{ year }}
          </summary>

          <div style="margin-left: 12px; margin-top: 4px;">
            {# Loop months descending; convert month number to month name #}
            {% for month in grouped[year].keys()|list|sort(reverse=true) %}
              {% set month_names = {
                '01': 'January', '02': 'February', '03': 'March', '04': 'April',
                '05': 'May', '06': 'June', '07': 'July', '08': 'August',
                '09': 'September', '10': 'October', '11': 'November', '12': 'December'
              } %}
              {% set month_label = month_names[month] %}

              <details style="margin-bottom: 4px;">
                <summary style="cursor: pointer;">
                  {{ month_label }}
                </summary>

                <div class="treemap-tabs" style="margin-left: 12px; margin-top: 4px;">
                  {# Reverse within each month to show latest date first #}
                  {% for name in grouped[year][month]|reverse %}
                    {% set date_str = name.replace('_treemap.html', '') %}
                    {% set meta = meta_by_date.get(date_str) %}
                    {% if meta %}
                      {# signed percent: [+/-][value]% with 2 decimals #}
                      {% set pct = meta.sp500_percent_change|float %}
                      {% if pct > 0 %}
                        {% set sign = '+' %}
                      {% elif pct < 0 %}
                        {% set sign = '-' %}
                      {% else %}
                        {% set sign = '' %}
                      {% endif %}
                      {% set pct_abs_str = '%.2f' % (pct|abs) %}
                      {% set pct_display = sign ~ pct_abs_str ~ '%' %}

                      {# tooltip text, single line #}
                      {% set tooltip = "S&P 500 % change: " ~ pct_display
                        ~ " | Total market cap: " ~ meta.total_market_cap %}

                      {# color based on sign #}
                      {% if pct > 0 %}
                        {% set tooltip_color = 'green' %}
                      {% elif pct < 0 %}
                        {% set tooltip_color = 'red' %}
                      {% else %}
                        {% set tooltip_color = 'neutral' %}
                      {% endif %}
                    {% else %}
                      {% set tooltip = "Date: " ~ date_str ~ " | No metadata available." %}
                      {% set tooltip_color = 'neutral' %}
                    {% endif %}

                    {% if data_source == 's3' %}
                      {# Build direct S3 object URL #}
                      {% set s3_url = "https://" ~ aws_bucket ~ ".s3." ~ aws_region ~ ".amazonaws.com/treemaps/" ~ name %}
                      <a href="{{ s3_url }}"
                        target="_blank"
                        class="treemap-tab"
                        data-tooltip="{{ tooltip }}"
                        data-tooltip-color="{{ tooltip_color }}">
                        {{ date_str }}
                      </a>
                    {% else %}
                      <a href="{{ url_for('treemap_file', filename=name) }}"
                        target="_blank"
                        class="treemap-tab"
                        data-tooltip="{{ tooltip }}"
                        data-tooltip-color="{{ tooltip_color }}">
                        {{ date_str }}
                      </a>
                    {% endif %}
                    
                  {% endfor %}
                </div>
              </details>
            {% endfor %}
          </div>
        </details>
      {% endfor %}
    </div>

  {% else %}
    <p>No treemap files found in the treemaps folder.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  const container = document.getElementById('data-source-container');
  const toggle = document.getElementById('data-source-toggle');
  const label = document.getElementById('data-source-label');

  let s3EnabledFlag = false;
  if (container) {
    const attr = container.getAttribute('data-s3-enabled');
    s3EnabledFlag = (attr === 'true');
  }

  if (toggle && s3EnabledFlag) {
    toggle.addEventListener('change', async () => {
      const source = toggle.checked ? 's3' : 'local';
      label.textContent = source === 's3' ? 'AWS S3' : 'Local';
      try {
        const resp = await fetch('/api/set_data_source', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) {
          alert('Failed to change data source');
          toggle.checked = false;
          label.textContent = 'Local';
          return;
        }
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert('Unexpected error changing data source');
        toggle.checked = false;
        label.textContent = 'Local';
      }
    });
  }
</script>

{% endblock %}

