{% extends "base.html" %}

{% block content %}
<div class="box">
  <h2>Market Status (NYSE)</h2>

  {% if market_open %}
    <p style="font-size: 15px; margin-top: 8px;">
      The market is currently <strong>OPEN</strong> (New York time).
    </p>
  {% else %}
    <p style="font-size: 14px; margin-top: 8px; color:#4b5563;">
      Next market open (New York time):
    </p>
    <p id="next-open-display"
       style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">
      <!-- filled by JS -->
    </p>

    <div style="margin-top: 8px;">
      <p style="font-size: 14px; margin-bottom: 4px;">Time until next open:</p>
      <div id="countdown"
           style="font-size: 20px; font-weight: 600; letter-spacing: 1px;">
        {{ rem_days }}d {{ rem_hours }}h {{ rem_minutes }}m {{ rem_seconds }}s
      </div>
    </div>
  {% endif %}
</div>


<!-- <div class="box" style="margin-top: 20px;">
  <h2>S&amp;P 500 Chart (Test Embed)</h2>
  <p style="font-size: 13px; color:#4b5563; margin-bottom: 8px;">
    Embedded <code>sp500_chart_to_display.html</code> below:
  </p>
  <iframe
    src="/graphs/sp500_chart_to_display.html"
    style="width: 100%; height: 480px; border: 1px solid #d1d5db; border-radius: 8px;"
  ></iframe> -->
</div>
{% endblock %}

{% block scripts %}
{% if not market_open and next_open_iso %}
<script>
  const nextOpenIso = "{{ next_open_iso }}";  // ISO with timezone
  const nextOpen = new Date(nextOpenIso);

  const nextOpenDisplay = document.getElementById('next-open-display');
  const countdownEl = document.getElementById('countdown');

  // Show the scheduled open time as a formatted local string, but indicate NY time
  if (nextOpenDisplay) {
    const opts = {
      year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      timeZoneName: 'short'
    };
    // Display in New York time explicitly
    const nyFormatter = new Intl.DateTimeFormat('en-US', { ...opts, timeZone: 'America/New_York' });
    nextOpenDisplay.textContent = nyFormatter.format(nextOpen);
  }

  function updateCountdown() {
    const now = new Date();
    const diffMs = nextOpen.getTime() - now.getTime();

    if (diffMs <= 0) {
      countdownEl.textContent = "Market should be open now.";
      clearInterval(timerId);
      return;
    }

    const totalSeconds = Math.floor(diffMs / 1000);
    const days = Math.floor(totalSeconds / (24 * 3600));
    const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  const timerId = setInterval(updateCountdown, 1000);
  updateCountdown();
</script>
{% endif %}
{% endblock %}
