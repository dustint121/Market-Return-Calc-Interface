{% extends "base.html" %}

{% block content %}
<div class="box">
  <h2>Market Status (NYSE)</h2>

  {% if market_open %}
    <p style="font-size: 15px; margin-top: 8px;">
      The market is currently <strong>OPEN</strong> (New York time).
    </p>

    <div style="margin-top: 16px;">
      <h3 style="margin: 0 0 8px 0; font-size: 14px;">* Below chart refreshes every minute during trading day</h3>
      <iframe
        id="candlestick-iframe"
        src="/graphs/sp500_candlestick_daily_1m.html"
        style="width: 100%; height: 480px; border: 1px solid #d1d5db; border-radius: 8px;"
      ></iframe>
    </div>
  {% else %}
    <!-- existing next-open + countdown block stays as-is -->
    <p style="font-size: 14px; margin-top: 8px; color:#4b5563;">
      Next market open (New York time):
    </p>
    <p id="next-open-display"
       style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">
    </p>

    <div style="margin-top: 8px;">
      <p style="font-size: 14px; margin-bottom: 4px;">Time until next open:</p>
      <div id="countdown"
           style="font-size: 20px; font-weight: 600; letter-spacing: 1px;">
        {{ rem_days }}d {{ rem_hours }}h {{ rem_minutes }}m {{ rem_seconds }}s
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if not market_open and next_open_iso %}
<script>
  const nextOpenIso = "{{ next_open_iso }}";
  const nextOpen = new Date(nextOpenIso);

  const nextOpenDisplay = document.getElementById('next-open-display');
  const countdownEl = document.getElementById('countdown');

  if (nextOpenDisplay) {
    const opts = {
      year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      timeZoneName: 'short', timeZone: 'America/New_York'
    };
    const formatter = new Intl.DateTimeFormat('en-US', opts);
    nextOpenDisplay.textContent = formatter.format(nextOpen);
  }

  function updateCountdown() {
    const now = new Date();
    const diffMs = nextOpen.getTime() - now.getTime();
    if (diffMs <= 0) {
      countdownEl.textContent = "Market should be open now.";
      clearInterval(timerId);
      return;
    }
    const totalSeconds = Math.floor(diffMs / 1000);
    const days = Math.floor(totalSeconds / (24 * 3600));
    const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  const timerId = setInterval(updateCountdown, 1000);
  updateCountdown();
</script>
{% endif %}

{% if market_open %}
<script>
  const iframe = document.getElementById('candlestick-iframe');
  if (iframe) {
    // reload every 60 seconds; adjust as needed
    setInterval(() => {
      // add a cache-buster query param so the browser doesn't use a cached copy
      const base = "/graphs/sp500_candlestick_daily_1m.html";
      const ts = Date.now();
      iframe.src = base + "?t=" + ts;
    }, 60000);
  }
</script>
{% endif %}

{% endblock %}
